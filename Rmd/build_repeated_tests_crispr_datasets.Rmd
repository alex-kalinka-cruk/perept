---
title: "Building repeated-tests CRISPR datasets"
author: "Alex Kalinka"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    depth: 3
    highlight: tango
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
params:
  root: "~/data/az_cruk/perept_data/ht29-iorio"
  out: "~/data/az_cruk/perept_data/ht29-iorio/paired_replicates"
  out_orig: "~/data/az_cruk/perept_data/ht29-iorio/original_screen_structure"
  fdr: !r 0.01
  lfc: !r 1
---

# Setup

```{r setup, include=FALSE}
options(warn=-1)
suppressMessages(library(knitr))
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))

data_root <- "~/data/az_cruk"

```

# Overview

The overall goal is to develop a set of standard repeated-tests CRISPR datasets that can be used in conjunction with the Maximum Likelihood estimates of false-positive and false-negative rates (implemented in the R package `perept`) to compare the performance of algorithm changes for the AZ-CRUK CRISPR analysis pipeline.

Three data sources will be used:

1. HT29 essentiality screens performed at Sanger.
2. EGFR treatment-control screens performed at AZ.
3. Veneto... treatment-control screen.

The HT29 data is not ideal as they are essentiality screens and the effect sizes will be large and not so relevant to drug treatment screens. However, there are a lot of replicates potentially providing power for discriminating the performance of different algorithms.

While the drug screens (2 and 3) are ideal screen types, they have very few replicates and will require sub-sampling of sgRNAs to create pseudo-replicates (respecting screen and sample origins). This is not ideal as it creates dependencies between the tests.

# HT29 essentiality screens provided by Francesco Iorio (Sanger)

**Approach**

* The data will be broken up into pairs of replicates since this is the structure of the data that will be used in the in-house CRISPR screens.
* Replicate pairs will always be taken from the same screen to respect the original structure of the data.
* There will be no overlaps between replicate pairs except in terms of the two plasmid count samples.

**Caveats**

* Only two sets of plasmid counts (named `ERS717283.plasmid` and `CRISPR_C6596666.sample`) are used throughout the screens which undermines the independence between different tests.

## Creating datasets

```{r,eval=F}
path_ht29 <- file.path(data_root,"ht29-francesco-iorio","01_Counts assembled")
# Assemble the sgRNAs, genes, and the two plasmid count replicates.
c903 <- read.table(file.path(path_ht29,"HT29_c903.tsv"), stringsAsFactors = F, header=T)
c905 <- read.table(file.path(path_ht29,"HT29_c905.tsv"), stringsAsFactors = F, header=T) %>%
  filter(sgRNA %in% c903$sgRNA)
common <- data.frame(c903[,1:3], c905$CRISPR_C6596666.sample)
colnames(common)[3:4] <- c("plasmid.1","plasmid.2")
c904 <- read.table(file.path(path_ht29,"HT29_c904.tsv"), stringsAsFactors = F, header=T)
c906 <- read.table(file.path(path_ht29,"HT29_c906.tsv"), stringsAsFactors = F, header=T) %>%
  filter(sgRNA %in% c903$sgRNA)
c907 <- read.table(file.path(path_ht29,"HT29_c907.tsv"), stringsAsFactors = F, header=T) %>%
  filter(sgRNA %in% c903$sgRNA)
c908 <- read.table(file.path(path_ht29,"HT29_c908.tsv"), stringsAsFactors = F, header=T) %>%
  filter(sgRNA %in% c903$sgRNA)
```

### Two replicates for 'treatments'

```{r,eval=F}
# c903 - 6 replicates, break into 3 non-overlapping sets of 2 replicates.
write.table(data.frame(common,c903[,4:5]), file = file.path(params$out,"ht29-perept-data-c903-1.tsv"),
            row.names = F, quote=F, sep="\t")
write.table(data.frame(common,c903[,6:7]), file = file.path(params$out,"ht29-perept-data-c903-2.tsv"),
            row.names = F, quote=F, sep="\t")
write.table(data.frame(common,c903[,8:9]), file = file.path(params$out,"ht29-perept-data-c903-3.tsv"),
            row.names = F, quote=F, sep="\t")
# c904 - 3 replicates, break into 2.
write.table(data.frame(common,c904[,4:5]), file = file.path(params$out,"ht29-perept-data-c904-1.tsv"),
            row.names = F, quote=F, sep="\t")
# c905 - 9 replicates, break into 4 sets of 2 replicates.
write.table(data.frame(common,c905[,4:5]), file = file.path(params$out,"ht29-perept-data-c905-1.tsv"),
            row.names = F, quote=F, sep="\t")
write.table(data.frame(common,c905[,6:7]), file = file.path(params$out,"ht29-perept-data-c905-2.tsv"),
            row.names = F, quote=F, sep="\t")
write.table(data.frame(common,c905[,8:9]), file = file.path(params$out,"ht29-perept-data-c905-3.tsv"),
            row.names = F, quote=F, sep="\t")
write.table(data.frame(common,c905[,10:11]), file = file.path(params$out,"ht29-perept-data-c905-4.tsv"),
            row.names = F, quote=F, sep="\t")
# c906 - 6 replicates, break into 3 sets of 2 replicates.
write.table(data.frame(common,c906[,4:5]), file = file.path(params$out,"ht29-perept-data-c906-1.tsv"),
            row.names = F, quote=F, sep="\t")
write.table(data.frame(common,c906[,6:7]), file = file.path(params$out,"ht29-perept-data-c906-2.tsv"),
            row.names = F, quote=F, sep="\t")
write.table(data.frame(common,c906[,8:9]), file = file.path(params$out,"ht29-perept-data-c906-3.tsv"),
            row.names = F, quote=F, sep="\t")
# c907 - 3 replicates, break into 2.
write.table(data.frame(common,c907[,4:5]), file = file.path(params$out,"ht29-perept-data-c907-1.tsv"),
            row.names = F, quote=F, sep="\t")
# c908 - 3 replicates, break into 2.
write.table(data.frame(common,c908[,4:5]), file = file.path(params$out,"ht29-perept-data-c908-1.tsv"),
            row.names = F, quote=F, sep="\t")

```

### Six screens as in the original structure

Just need to add both plasmids to each 

```{r,eval=F}
# c903.
write.table(data.frame(common,c903[,4:9]), file = file.path(params$out_orig,"ht29-perept-data-c903.tsv"),
            row.names = F, quote=F, sep="\t")
# c904.
write.table(data.frame(common,c904[,4:6]), file = file.path(params$out_orig,"ht29-perept-data-c904.tsv"),
            row.names = F, quote=F, sep="\t")
# c905.
write.table(data.frame(common,c905[,4:12]), file = file.path(params$out_orig,"ht29-perept-data-c905.tsv"),
            row.names = F, quote=F, sep="\t")
# c906.
write.table(data.frame(common,c906[,4:9]), file = file.path(params$out_orig,"ht29-perept-data-c906.tsv"),
            row.names = F, quote=F, sep="\t")
# c907.
write.table(data.frame(common,c907[,4:6]), file = file.path(params$out_orig,"ht29-perept-data-c907.tsv"),
            row.names = F, quote=F, sep="\t")
# c908.
write.table(data.frame(common,c908[,4:6]), file = file.path(params$out_orig,"ht29-perept-data-c908.tsv"),
            row.names = F, quote=F, sep="\t")

```

## Creating algorithm-specific gene matrices

### Mageck

```{r}
# Read in Mageck 'gene_summary' files (ranked by negative hits) and process.
process_mageck_output <- function(file_list){
  ret <- NULL
  for(file in file_list){
    screen_name <- gsub("^(.*?)\\.gene_summ.*$","\\1",tail(unlist(strsplit(file,"/")),1))
    ts <- read.table(file, header=T, stringsAsFactors = F) %>%
      arrange(id) %>%
      rowwise() %>%
      mutate(neg_hit = ifelse(neg.fdr < params$fdr,1,0),
             pos_hit = ifelse(pos.fdr < params$fdr,1,0),
             neg_or_pos_hit = ifelse((neg_hit==1 || pos_hit==1),1,0)) %>%
      ungroup() %>%
      select(id,neg_hit,pos_hit,neg_or_pos_hit)
    if(is.null(ret)){
      ret <- ts
    }else{
      ret <- cbind(ret, ts %>% select(-id))
    }
    # Rename columns.
    ret %<>%
      rename(!!paste(screen_name,".neg_hit",sep="") := neg_hit, 
             !!paste(screen_name,".pos_hit",sep="") := pos_hit, 
             !!paste(screen_name,".neg_or_pos_hit",sep="") := neg_or_pos_hit)
  }
  return(ret)
}

# Paired replicates.
files <- list.files(file.path(params$root,"output","mageck","paired_replicates"), 
                    pattern = "gene_summary.txt$", full.names = T)
ht29.mageck_hit_matrix <- process_mageck_output(files)

ht29.mageck_neg <- ht29.mageck_hit_matrix %>%
  select(id, contains("neg_hit")) %>%
  mutate(pos_count = rowSums(.[2:14]))

# Original screen structure.
files.orig <- list.files(file.path(params$root,"output","mageck","original_screen_structure"), 
                    pattern = "gene_summary.txt$", full.names = T)
ht29.mageck_hit_matrix.orig <- process_mageck_output(files.orig)

ht29.mageck_neg.orig <- ht29.mageck_hit_matrix.orig %>%
  select(id, contains("neg_hit")) %>%
  mutate(pos_count = rowSums(.[2:7]))

```

### drugZ

```{r}
# Read in drugZ output files (ranked by negative hits) and process.
process_drugz_output <- function(file_list){
  ret <- NULL
  for(file in file_list){
    screen_name <- gsub("^(.*?)-drugz\\.txt$","\\1",tail(unlist(strsplit(file,"/")),1))
    ts <- read.table(file, header=T, stringsAsFactors = F) %>%
      arrange(GENE) %>%
      rowwise() %>%
      mutate(neg_hit = ifelse(fdr_synth < params$fdr,1,0)) %>%
      ungroup() %>%
      select(GENE,neg_hit)
    if(is.null(ret)){
      ret <- ts
    }else{
      ret <- cbind(ret, ts %>% select(-GENE))
    }
    # Rename columns.
    ret %<>%
      rename(!!paste(screen_name,".neg_hit",sep="") := neg_hit)
  }
  return(ret)
}

# Paired replicates.
files.drugz <- list.files(file.path(params$root,"output","drugz","paired_replicates"), 
                    pattern = "txt$", full.names = T)
ht29.drugz_hit_matrix <- process_drugz_output(files.drugz)

ht29.drugz_neg <- ht29.drugz_hit_matrix %>%
  select(GENE, contains("neg_hit")) %>%
  mutate(pos_count = rowSums(.[2:14]))

# Original screen structure.
files.drugz.orig <- list.files(file.path(params$root,"output","drugz","original_screen_structure"), 
                    pattern = "txt$", full.names = T)
ht29.drugz_hit_matrix.orig <- process_drugz_output(files.drugz.orig)

ht29.drugz_neg.orig <- ht29.drugz_hit_matrix.orig %>%
  select(GENE, contains("neg_hit")) %>%
  mutate(pos_count = rowSums(.[2:7]))

```


